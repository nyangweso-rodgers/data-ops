# Base Dagster configuration - shared across all environments
#
# Usage:
#   Local: docker-compose -f docker-compose-dagster.base.yml -f docker-compose-dagster.local.yml up
#   Dev:   docker-compose -f docker-compose-dagster.base.yml -f docker-compose-dagster.dev.yml up
#   Prod:  docker-compose -f docker-compose-dagster.base.yml -f docker-compose-dagster.prod.yml up

services:
  # ============================================================================
  # DAGSTER gRPC SERVER - Core compute engine
  # ============================================================================
  dagster:
    build:
      context: .
      dockerfile: Dockerfile
    image: dagster
    container_name: dagster
    command:
      [
        "dagster",
        "api",
        "grpc",
        "-h",
        "0.0.0.0",
        "-p",
        "4000",
        "-m",
        "dagster_pipeline",
      ]
    env_file:
      - ../../.env # Global env vars
      - .env.dagster # Dagster-specific env vars
    environment:
      # Core Dagster settings
      - DAGSTER_HOME=/app/dagster_home
      - PYTHONPATH=/app

      # ═══════════════════════════════════════════════════════════════════
      # DAGSTER POSTGRES (State Management)
      # These will be overridden by docker-compose-dagster.local.yml or .prod.yml
      # ═══════════════════════════════════════════════════════════════════
      #- DAGSTER_POSTGRES_HOST=${DAGSTER_PG_DB_HOST}
      #- DAGSTER_POSTGRES_PORT=${DAGSTER_PG_DB_PORT:-5432}
      #- DAGSTER_POSTGRES_USER=${DAGSTER_PG_DB_USER}
      #- DAGSTER_POSTGRES_PASSWORD=${DAGSTER_PG_DB_PASSWORD}
      #- DAGSTER_POSTGRES_DB=${DAGSTER_PG_DB_NAME}
    volumes:
      - ./dagster_home/:/app/dagster_home
      - ./dagster_pipeline:/app/dagster_pipeline
    networks:
      - data-ops-network
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import socket; s = socket.socket(); s.connect(('localhost', 4000)); s.close()",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================================================
  # DAGSTER WEBSERVER - UI and API
  # ============================================================================
  dagster_webserver:
    image: dagster
    container_name: dagster_webserver
    command:
      [
        "dagster-webserver",
        "-h",
        "0.0.0.0",
        "-p",
        "3004",
        "-w",
        "/app/dagster_home/workspace.yaml",
      ]
    env_file:
      - ../../.env
      - .env.dagster
    environment:
      - DAGSTER_HOME=/app/dagster_home
      - PYTHONPATH=/app

      # ═══════════════════════════════════════════════════════════════════
      # DAGSTER POSTGRES (State Management)
      # These will be overridden by docker-compose-dagster.local.yml or .prod.yml
      # ═══════════════════════════════════════════════════════════════════
      #- DAGSTER_POSTGRES_HOST=${DAGSTER_PG_DB_HOST}
      #- DAGSTER_POSTGRES_PORT=${DAGSTER_PG_DB_PORT:-5432}
      #- DAGSTER_POSTGRES_USER=${DAGSTER_PG_DB_USER}
      #- DAGSTER_POSTGRES_PASSWORD=${DAGSTER_PG_DB_PASSWORD}
      #- DAGSTER_POSTGRES_DB=${DAGSTER_PG_DB_NAME}
    volumes:
      - ./dagster_home:/app/dagster_home
      - ./dagster_pipeline:/app/dagster_pipeline
    networks:
      - data-ops-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3004"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================================================
  # DAGSTER DAEMON - Runs Schedules & Sensors
  # ============================================================================
  dagster_daemon:
    image: dagster # Reuse built image
    container_name: dagster_daemon
    command: ["dagster-daemon", "run", "-w", "/app/dagster_home/workspace.yaml"]
    env_file:
      - ../../.env
      - .env.dagster
    environment:
      - DAGSTER_HOME=/app/dagster_home
      - PYTHONPATH=/app

      # ═══════════════════════════════════════════════════════════════════
      # DAGSTER POSTGRES (State Management)
      # These will be overridden by docker-compose-dagster.local.yml or .prod.yml
      # ═══════════════════════════════════════════════════════════════════
      #- DAGSTER_POSTGRES_HOST=${DAGSTER_PG_DB_HOST}
      #- DAGSTER_POSTGRES_PORT=${DAGSTER_PG_DB_PORT:-5432}
      #- DAGSTER_POSTGRES_USER=${DAGSTER_PG_DB_USER}
      #- DAGSTER_POSTGRES_PASSWORD=${DAGSTER_PG_DB_PASSWORD}
      #- DAGSTER_POSTGRES_DB=${DAGSTER_PG_DB_NAME}
    volumes:
      - ./dagster_home:/app/dagster_home
      - ./dagster_pipeline:/app/dagster_pipeline
    networks:
      - data-ops-network

# ============================================================================
# Networks
# ============================================================================
networks:
  data-ops-network:
    external: true
